# Stage2 æ¨¡å‹ç»­å†™é—®é¢˜ä¿®å¤æ–¹æ¡ˆ

## é—®é¢˜è¯Šæ–­

âœ… **æ–‡é£å­¦ä¹ **: æ¨¡å‹æˆåŠŸå­¦åˆ°äº†æ–‡å­¦é£æ ¼æ”¹å†™èƒ½åŠ›  
âœ… **æ”¹å†™èƒ½åŠ›**: æ¨¡å‹èƒ½æ­£ç¡®å®Œæˆæ–‡æœ¬æ”¹å†™ä»»åŠ¡  
âŒ **è¡Œä¸ºè¾¹ç•Œ**: æ¨¡å‹åœ¨å®Œæˆæ”¹å†™åç»§ç»­ç”Ÿæˆæ— å…³å¯¹è¯

**ç—‡çŠ¶**: æ¨¡å‹è¾“å‡ºæ­£ç¡®æ”¹å†™åï¼Œç»§ç»­ç”Ÿæˆ `\nuser\n` æˆ– `\nsystem\n`ï¼Œç„¶åäº§ç”Ÿæ— å…³å†…å®¹ï¼ˆå¦‚ç‰å¦‚/ç‡•è¥¿å¯¹è¯ï¼‰

**æ ¹æœ¬åŸå› **: è®­ç»ƒæ•°æ®çš„ labels åŒ…å«äº†è§’è‰²æ ‡è®°ï¼ˆsystem/user/assistantï¼‰ï¼Œå¯¼è‡´æ¨¡å‹å­¦åˆ°"ç»§ç»­å¯¹è¯"è€Œé"å®Œæˆä»»åŠ¡ååœæ­¢"

---

## äº”æ­¥ä¿®å¤æ–¹æ¡ˆ

### âœ… ç¬¬ä¸€æ­¥ï¼šç«‹å³æ­¢è¡€ï¼ˆä¸é‡è®­ä¹Ÿèƒ½ç”¨ï¼‰

**ç›®æ ‡**: è®©æ¨¡å‹åˆ«å†è‡ªå·±å¼€å¯æ–°ä¸€è½® user/system

**ä¿®æ”¹æ–‡ä»¶**: `lora/test_stage2_instruction.py`

**æ”¹åŠ¨**:
1. åœ¨ `model.generate()` ä¸­æ·»åŠ  `eos_token_id` åˆ—è¡¨ï¼ŒåŒ…å«ç‰¹æ®Š token
2. å°† `max_new_tokens` ä» 320 æå‡åˆ° 512
3. åœ¨ system prompt ä¸­æ·»åŠ ç¡¬çº¦æŸï¼š"ä½ çš„å›å¤å¿…é¡»åœ¨å®Œæˆæ”¹å†™åç«‹å³ç»“æŸï¼Œä¸å¾—ç»§ç»­ç”Ÿæˆä»»ä½•å¯¹è¯ã€æç¤ºæˆ–æ–°ä»»åŠ¡ã€‚"

**æ•ˆæœ**: å¯ä»¥ç«‹åˆ»æ¶ˆç­ 90% çš„"æ— å…³ç»­å†™"ï¼Œæ— éœ€é‡æ–°è®­ç»ƒ

**æµ‹è¯•**:
```bash
python -m lora.test_stage2_instruction \
    --model_name_or_path stage2_instruction_tuning/checkpoint-158 \
    --preset zhang_henshui
```

---

### âœ… ç¬¬äºŒæ­¥ï¼šä¿®å¤è®­ç»ƒæ•°æ®æ ‡æ³¨ï¼ˆæœ€å…³é”®ï¼‰

**ç›®æ ‡**: è®©æ¨¡å‹çŸ¥é“ï¼šæˆ‘åªè´Ÿè´£æ”¹å†™ï¼Œä¸è´Ÿè´£å¯¹è¯ç»­å†™

**é—®é¢˜**: æ—§ç‰ˆ `stage2_instruction_tuning.py` çš„ `formatting_func_stage2` å°†æ•´ä¸ªå¯¹è¯æ–‡æœ¬ï¼ˆåŒ…æ‹¬ `<|im_start|>system`ã€`<|im_start|>user`ã€`<|im_start|>assistant`ï¼‰éƒ½ä½œä¸º labelsï¼Œå¯¼è‡´æ¨¡å‹å­¦åˆ°"æ¥ç€æ¼”"çš„è¡Œä¸º

**ä¿®å¤**: ç°åœ¨ `lora/stage2_instruction_tuning.py` å·²æ›´æ–°ä¸ºä¿®å¤ç‰ˆæœ¬

**æ ¸å¿ƒä¿®å¤**:
```python
def formatting_func_stage2_fixed(example, tokenizer, max_seq_length=2048):
    """
    âœ… æ­£ç¡®åšæ³•ï¼š
      - input_ids: åŒ…å«å®Œæ•´å¯¹è¯ï¼ˆsystem + user + assistant å¼€å¤´ï¼‰
      - labels: åªæ ‡æ³¨ assistant çš„å›å¤æ–‡æœ¬ï¼Œå…¶ä»–éƒ¨åˆ†è®¾ä¸º -100ï¼ˆå¿½ç•¥ï¼‰
    
    âŒ é”™è¯¯åšæ³•ï¼ˆæ—§ç‰ˆï¼‰ï¼š
      - æ•´ä¸ªæ–‡æœ¬éƒ½ä½œä¸º labelï¼Œå¯¼è‡´æ¨¡å‹å­¦åˆ° "ç»§ç»­å¯¹è¯" çš„è¡Œä¸º
    """
    # ... (è¯¦è§ä»£ç )
    
    # å…³é”®ï¼šæ„å»º labels æ—¶ï¼Œåªæœ‰ assistant å›å¤éƒ¨åˆ†æ˜¯æœ‰æ•ˆçš„
    labels = [-100] * len(prompt_ids) + full_ids[len(prompt_ids):]
```

**éªŒè¯æœºåˆ¶**: è„šæœ¬ä¼šæ‰“å°ç¬¬ä¸€ä¸ªæ ·æœ¬çš„ labelsï¼Œç¡®ä¿ä¸åŒ…å« role markers

---

### âœ… ç¬¬ä¸‰æ­¥ï¼šç»“æ„åŒ–è§’è‰²ï¼ˆé˜²å¤å‘ï¼‰

**ç›®æ ‡**: è®©æ¨¡å‹"è®¤è¯†è§’è‰²"ï¼Œè€Œä¸æ˜¯æ¨¡ä»¿å­—é¢æ–‡æœ¬

**å®ç°**: ä½¿ç”¨ ChatML æ ¼å¼çš„ç‰¹æ®Š tokenï¼š
- `<|im_start|>system`, `<|im_start|>user`, `<|im_start|>assistant`
- `<|im_end|>`

**å…³é”®**: è¿™äº› token åªåœ¨ prompt ä¸­å‡ºç°ï¼Œ**æ°¸è¿œä¸è¿› labels**

---

### âœ… ç¬¬å››æ­¥ï¼šè½»é‡é‡è®­ï¼ˆåŠå¤©å†…æå®šï¼‰

**ç›®æ ‡**: ç”¨ 10-20% æ•°æ®è¿›è¡Œ"è¡Œä¸ºæ ¡æ­£"è®­ç»ƒ

**å¥½æ¶ˆæ¯**: ä¸éœ€è¦ä»å¤´è®­ç»ƒï¼åªéœ€è½»é‡çº§å¾®è°ƒè®©æ¨¡å‹"å¿˜æ‰åä¹ æƒ¯"

#### æ­¥éª¤ 1: å‡†å¤‡æ•°æ®å­é›†

```bash
python prepare_correction_subset.py \
    --input_path data/stage2_sample_5000.jsonl \
    --output_path data/stage2_sample_subset_1000.jsonl \
    --ratio 0.2
```

#### æ­¥éª¤ 2: è¿è¡Œä¿®æ­£è®­ç»ƒ

```bash
python -m lora.stage2_instruction_tuning \
    --config lora/stage2_correction_config.json
```

**é…ç½®è¯´æ˜** (`stage2_correction_config.json`):
- `model_name_or_path`: `stage1_style_injection/checkpoint-531` (ä» Stage1 é‡æ–°å¼€å§‹)
- `dataset_path`: `data/stage2_sample_subset_1000.jsonl` (20% å­é›†)
- `learning_rate`: `8e-5` (ç¨é«˜ï¼Œå¸®åŠ©"å¿˜æ‰åä¹ æƒ¯")
- `num_train_epochs`: `1.0` (ä¸€è½®å³å¯)
- å…¶ä»–è¶…å‚æ•°ä¿æŒä¸åŸ Stage2 ä¸€è‡´

**é¢„æœŸæ•ˆæœ**:
- ä¿ç•™æ–‡é£å­¦ä¹ æˆæœ
- ä¿®æ­£è¡Œä¸ºè¾¹ç•Œé—®é¢˜
- è®­ç»ƒæ—¶é—´çº¦ä¸ºåŸ Stage2 çš„ 20%

---

### âœ… ç¬¬äº”æ­¥ï¼šç³»ç»Ÿæç¤ºä¿é™©ä¸

**ç›®æ ‡**: æœ€åä¸€é“é˜²çº¿

**å®ç°**: å·²åœ¨ Step 1 ä¸­æ·»åŠ åˆ° system promptï¼š

```python
"ä½ çš„å›å¤å¿…é¡»åœ¨å®Œæˆæ”¹å†™åç«‹å³ç»“æŸï¼Œä¸å¾—ç»§ç»­ç”Ÿæˆä»»ä½•å¯¹è¯ã€æç¤ºæˆ–æ–°ä»»åŠ¡ã€‚"
```

è¿™ä¸æ˜¯æ ¹æ²»æ–¹æ¡ˆï¼Œä½†èƒ½ä½œä¸ºæœ€åä¸€é“é—¸é—¨ã€‚

---

## æ–‡ä»¶æ¸…å•

### ä¿®å¤åçš„æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|
| `lora/test_stage2_instruction.py` | æµ‹è¯•è„šæœ¬ï¼ˆå·²æ·»åŠ  stop tokens å’Œç¡¬çº¦æŸï¼‰ | âœ… å·²ä¿®å¤ |
| `lora/stage2_instruction_tuning.py` | ä¿®å¤åçš„è®­ç»ƒè„šæœ¬ï¼ˆæ­£ç¡®çš„ label åˆ†å‰²ï¼‰ | âœ… å·²ä¿®å¤ |
| `lora/stage2_correction_config.json` | è½»é‡é‡è®­é…ç½® | âœ… æ–°å»º |
| `prepare_correction_subset.py` | æ•°æ®å­é›†å‡†å¤‡è„šæœ¬ | âœ… æ–°å»º |



---

## å¿«é€Ÿå¼€å§‹

### 1. ç«‹å³æµ‹è¯•ï¼ˆæ— éœ€é‡è®­ï¼‰

```bash
# ä½¿ç”¨ä¿®å¤åçš„æµ‹è¯•è„šæœ¬
python -m lora.test_stage2_instruction \
    --model_name_or_path stage2_instruction_tuning/checkpoint-158 \
    --preset zhang_henshui
```

**é¢„æœŸ**: æ¨¡å‹åº”è¯¥åœ¨æ”¹å†™å®Œæˆååœæ­¢ï¼Œä¸å†ç”Ÿæˆæ— å…³å¯¹è¯

---

### 2. é‡æ–°è®­ç»ƒï¼ˆæ¨èï¼‰

#### æ­¥éª¤ 1: å‡†å¤‡ 20% æ•°æ®å­é›†
```bash
python prepare_correction_subset.py \
    --input_path data/stage2_sample_5000.jsonl \
    --output_path data/stage2_sample_subset_1000.jsonl \
    --ratio 0.2
```

#### æ­¥éª¤ 2: è¿è¡Œä¿®æ­£è®­ç»ƒ
```bash
python -m lora.stage2_instruction_tuning \
    --config lora/stage2_correction_config.json
```

#### æ­¥éª¤ 3: æµ‹è¯•æ–°æ¨¡å‹
```bash
python -m lora.test_stage2_instruction \
    --model_name_or_path stage2_instruction_tuning_corrected/checkpoint-50 \
    --preset zhang_henshui
```

---

## æŠ€æœ¯ç»†èŠ‚

### ä¸ºä»€ä¹ˆ labels åŒ…å« role markers æ˜¯é”™è¯¯çš„ï¼Ÿ

**é”™è¯¯ç¤ºä¾‹**ï¼ˆæ—§ç‰ˆï¼‰:
```python
# æ•´ä¸ªå¯¹è¯æ–‡æœ¬ä½œä¸º labels
text = """<|im_start|>system
ä½ æ˜¯ä¸€ä¸ªæ–‡å­¦åˆ›ä½œåŠ©æ‰‹ã€‚<|im_end|>
<|im_start|>user
è¯·æ”¹å†™è¿™æ®µæ–‡å­—...<|im_end|>
<|im_start|>assistant
æ”¹å†™åçš„æ–‡å­—...<|im_end|>"""

# âŒ æ¨¡å‹å­¦åˆ°ï¼šçœ‹åˆ° <|im_end|> åå¯ä»¥ç»§ç»­ç”Ÿæˆ <|im_start|>user
```

**æ­£ç¡®ç¤ºä¾‹**ï¼ˆæ–°ç‰ˆï¼‰:
```python
# Promptï¼ˆä¸è®¡å…¥ lossï¼‰
prompt = """<|im_start|>system
ä½ æ˜¯ä¸€ä¸ªæ–‡å­¦åˆ›ä½œåŠ©æ‰‹ã€‚<|im_end|>
<|im_start|>user
è¯·æ”¹å†™è¿™æ®µæ–‡å­—...<|im_end|>
<|im_start|>assistant
"""

# Labelsï¼ˆåªè®¡å…¥ lossï¼‰
labels = "æ”¹å†™åçš„æ–‡å­—...<|im_end|>"

# âœ… æ¨¡å‹å­¦åˆ°ï¼šç”Ÿæˆæ”¹å†™æ–‡å­— + <|im_end|> åå°±åœæ­¢
```

### éªŒè¯æ–¹æ³•

æ–°è®­ç»ƒè„šæœ¬ä¼šåœ¨è®­ç»ƒå¼€å§‹å‰æ‰“å°ç¬¬ä¸€ä¸ªæ ·æœ¬çš„ labels:

```bash
ğŸ” éªŒè¯ç¬¬ä¸€ä¸ªæ ·æœ¬çš„ labels (åº”è¯¥åªåŒ…å« assistant å›å¤):
Labels preview (å‰200å­—ç¬¦): æ”¹å†™åçš„æ–‡å­—å†…å®¹...
âœ… Labels çœ‹èµ·æ¥æ­£ç¡®ï¼ˆåªæœ‰å›å¤å†…å®¹ï¼‰
```

å¦‚æœçœ‹åˆ°ä»¥ä¸‹å†…å®¹ï¼Œè¯´æ˜æœ‰é—®é¢˜ï¼š
```bash
âš ï¸  WARNING: Labels åŒ…å« role markersï¼è¿™ä¼šå¯¼è‡´æ¨¡å‹ç»§ç»­å¯¹è¯ã€‚
```

---

## é¢„æœŸæ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰
```
User: è¯·æ”¹å†™...
Assistant: [æ­£ç¡®çš„æ”¹å†™å†…å®¹]
user
ç‰å¦‚è¯´ï¼š"ä½ æœ‰å¥³æœ‹å‹å—ï¼Ÿ"
ç‡•è¥¿ç­”...ï¼ˆæ— å…³å¯¹è¯ç»§ç»­ï¼‰
```

### ä¿®å¤å
```
User: è¯·æ”¹å†™...
Assistant: [æ­£ç¡®çš„æ”¹å†™å†…å®¹]
[åœæ­¢]
```

---

## å¸¸è§é—®é¢˜

### Q: å¿…é¡»é‡æ–°è®­ç»ƒå—ï¼Ÿ
A: ä¸ä¸€å®šã€‚Step 1 çš„ä¿®å¤ï¼ˆstop tokens + ç³»ç»Ÿæç¤ºï¼‰å¯ä»¥æ¶ˆç­ 90% çš„é—®é¢˜ã€‚å¦‚æœéœ€è¦å½»åº•è§£å†³ï¼Œå»ºè®®è¿›è¡Œ Step 4 çš„è½»é‡é‡è®­ï¼ˆåªéœ€ 20% æ•°æ®ï¼Œä¸€è½®è®­ç»ƒï¼‰ã€‚

### Q: ä¼šä¸ä¼šç ´åå·²ç»å­¦åˆ°çš„æ–‡é£ï¼Ÿ
A: ä¸ä¼šã€‚è½»é‡é‡è®­åªæ˜¯"è¡Œä¸ºæ ¡æ­£"ï¼Œä¸ä¼šæ”¹å˜æ¨¡å‹å¯¹æ–‡é£çš„ç†è§£ã€‚æ•°æ®è¿˜æ˜¯åŒæ ·çš„æ”¹å†™ä»»åŠ¡ï¼Œåªæ˜¯æ ‡æ³¨æ–¹å¼æ›´æ­£ç¡®ã€‚

### Q: ä¸ºä»€ä¹ˆä¸ä» checkpoint-158 ç»§ç»­è®­ç»ƒï¼Ÿ
A: checkpoint-158 å·²ç»å­¦åˆ°äº†"ç»§ç»­å¯¹è¯"çš„åä¹ æƒ¯ã€‚ä» Stage1 checkpoint-531 é‡æ–°å¼€å§‹ï¼Œä½¿ç”¨æ­£ç¡®çš„ labelsï¼Œæ•ˆæœæ›´å¥½ã€‚

### Q: å¦‚ä½•åˆ¤æ–­ä¿®å¤æ˜¯å¦æˆåŠŸï¼Ÿ
A: è¿è¡Œæµ‹è¯•è„šæœ¬ï¼Œå¦‚æœæ¨¡å‹åœ¨æ”¹å†™å®Œæˆåç«‹å³åœæ­¢ï¼ˆä¸ç”Ÿæˆ `\nuser\n` æˆ–å…¶ä»–æ— å…³å†…å®¹ï¼‰ï¼Œè¯´æ˜ä¿®å¤æˆåŠŸã€‚

---

## æ€»ç»“

| æ­¥éª¤ | æ•ˆæœ | æ—¶é—´æˆæœ¬ | æ¨èåº¦ |
|------|------|----------|--------|
| Step 1: Stop tokens | 90% æ”¹å–„ | 5 åˆ†é’Ÿ | â­â­â­â­â­ |
| Step 2-4: ä¿®å¤è®­ç»ƒ | 100% æ ¹æ²» | åŠå¤© | â­â­â­â­â­ |
| Step 5: ç³»ç»Ÿæç¤º | è¾…åŠ©é˜²çº¿ | 1 åˆ†é’Ÿ | â­â­â­ |

**å»ºè®®æµç¨‹**:
1. ç«‹å³åº”ç”¨ Step 1ï¼Œæµ‹è¯•æ•ˆæœ
2. å¦‚æœ Step 1 è¶³å¤Ÿå¥½ï¼Œå¯ä»¥æš‚æ—¶ä½¿ç”¨
3. æœ‰æ—¶é—´æ—¶è¿›è¡Œ Step 2-4 çš„å®Œæ•´ä¿®å¤ï¼Œå½»åº•è§£å†³é—®é¢˜

---

## é¸£è°¢

æœ¬ä¿®å¤æ–¹æ¡ˆåŸºäºå¯¹è¯å¼ LLM è®­ç»ƒçš„æœ€ä½³å®è·µï¼Œæ ¸å¿ƒæ€æƒ³ï¼š
- **Labels åªåŒ…å«æ¨¡å‹åº”è¯¥ç”Ÿæˆçš„å†…å®¹**
- **Prompt ä¸è®¡å…¥ loss**
- **è§’è‰²æ ‡è®°æ°¸è¿œä¸è¿› labels**

è¿™æ˜¯ instruction tuning çš„æ ‡å‡†åšæ³•ï¼Œä¹Ÿæ˜¯ OpenAIã€Anthropic ç­‰å…¬å¸ä½¿ç”¨çš„æ–¹æ³•ã€‚
